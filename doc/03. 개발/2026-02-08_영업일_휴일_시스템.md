# ì˜ì—…ì¼/íœ´ì¼ êµ¬ë¶„ ì‹œìŠ¤í…œ êµ¬í˜„ ì‘ì—… ê¸°ë¡

**ì‘ì—…ì¼**: 2026-02-08  
**ì‘ì—… ì‹œê°„**: 00:10 ~ 00:40

---

## ğŸ¯ ëª©í‘œ

ì£¼ë§/íœ´ì¼ì— í•œíˆ¬ APIê°€ ì‘ë™í•˜ì§€ ì•ŠëŠ” ë¬¸ì œ í•´ê²°:
- **ì˜ì—…ì¼ 15:30 ì´ì „**: KIS API ì¡°íšŒë§Œ (DB ì €ì¥ ì•ˆ í•¨)
- **ì˜ì—…ì¼ 15:30 ì´í›„**: KIS API ì¡°íšŒ + DB ì €ì¥
- **íœ´ì¼**: ë§ˆì§€ë§‰ ì˜ì—…ì¼ DB ë°ì´í„° ì¡°íšŒ

---

## âœ… ì™„ë£Œëœ ì‘ì—…

### 1. DB ëª¨ë¸ ì¶”ê°€
**íŒŒì¼**: `app/models/daily_ranking.py`

```python
class DailyRanking(Base):
    __tablename__ = "daily_rankings"
    
    id = Column(Integer, primary_key=True)
    trade_date = Column(Date, nullable=False, index=True)
    stock_code = Column(String(10), nullable=False)
    stock_name = Column(String(100), nullable=False)
    rank = Column(Integer, nullable=False)
    current_price = Column(Integer, nullable=False)
    change_price = Column(Integer, nullable=False)
    change_rate = Column(Float, nullable=False)
    volume = Column(BigInteger, nullable=False)
    trading_value = Column(BigInteger, nullable=False)
    created_at = Column(DateTime, server_default=func.now())
    
    # ìœ ë‹ˆí¬ ì œì•½: ë‚ ì§œ + ì¢…ëª©ì½”ë“œ
    __table_args__ = (
        UniqueConstraint('trade_date', 'stock_code'),
        Index('idx_trade_date_rank', 'trade_date', 'rank'),
    )
```

### 2. ì˜ì—…ì¼ íŒë‹¨ ìœ í‹¸ë¦¬í‹°
**íŒŒì¼**: `app/utils/business_day.py`

**ì£¼ìš” í•¨ìˆ˜:**
- `is_business_day()`: ì˜ì—…ì¼ ì—¬ë¶€ (ì£¼ë§ ì œì™¸)
- `is_market_closed()`: ì¥ ë§ˆê° ì—¬ë¶€ (15:30 ì´í›„)
- `get_last_business_date()`: ë§ˆì§€ë§‰ ì˜ì—…ì¼ ì¡°íšŒ
- `get_kst_now()`: KST ê¸°ì¤€ í˜„ì¬ ì‹œê°„

### 3. CRUD í•¨ìˆ˜
**íŒŒì¼**: `app/crud/daily_ranking.py`

**ì£¼ìš” í•¨ìˆ˜:**
- `save_daily_rankings()`: ì¼ì¼ ìˆœìœ„ ì €ì¥ (DELETE â†’ INSERT)
- `get_rankings_by_date()`: íŠ¹ì • ë‚ ì§œ ìˆœìœ„ ì¡°íšŒ
- `get_latest_ranking_date()`: ìµœê·¼ ë°ì´í„° ë‚ ì§œ ì¡°íšŒ

### 4. API ë¡œì§ ìˆ˜ì •
**íŒŒì¼**: `app/api/v1/rankings.py`

**ë³€ê²½ ë‚´ìš©:**
```python
@router.get("/volume-rank-by-theme")
async def get_volume_rank_by_theme(db: AsyncSession = Depends(get_db)):
    # 1. ìºì‹œ í™•ì¸
    # 2. ì˜ì—…ì¼ ì—¬ë¶€ í™•ì¸
    if is_business_day():
        # KIS API ì¡°íšŒ
        rankings = await kis_client.get_volume_rank(limit=100)
        
        # 15:30 ì´í›„ë©´ DB ì €ì¥
        if is_market_closed():
            await crud_daily_ranking.save_daily_rankings(db, today, rankings)
    else:
        # íœ´ì¼: ë§ˆì§€ë§‰ ì˜ì—…ì¼ DB ì¡°íšŒ
        rankings = await crud_daily_ranking.get_rankings_by_date(db, last_date)
    
    # 3. í…Œë§ˆë³„ ë¶„ë¥˜ ë° ì •ë ¬
    # 4. ìºì‹œ ì €ì¥ (10ì´ˆ)
```

### 5. ì˜ì¡´ì„± ì¶”ê°€
**íŒŒì¼**: `requirements.txt`

```txt
pytz==2024.1  # í•œêµ­ ì‹œê°„ëŒ€ ì²˜ë¦¬
```

### 6. Import ì˜¤ë¥˜ ìˆ˜ì •

**models/__init__.py**:
```python
from app.models.daily_ranking import DailyRanking
__all__ = ["Theme", "Stock", "ThemeStock", "DailyRanking"]
```

**crud/__init__.py**:
```python
from app.crud import daily_ranking
__all__ = ["theme", "stock", "theme_stock", "daily_ranking"]
```

**utils/__init__.py**: ìƒì„±

---

## ğŸ”§ ì§„í–‰ ì¤‘

### Alembic ë§ˆì´ê·¸ë ˆì´ì…˜
```bash
# ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±
docker exec stocktheme-backend alembic revision --autogenerate -m "Add daily_rankings table"

# ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©
docker exec stocktheme-backend alembic upgrade head
```

**ìƒíƒœ**: ì‹¤í–‰ ì¤‘

---

## âš ï¸ ë°œìƒí•œ ë¬¸ì œ ë° í•´ê²°

### ë¬¸ì œ 1: Backend ì‹œì‘ ì‹¤íŒ¨
**ì›ì¸**: DailyRanking ëª¨ë¸ì´ `__init__.py`ì— ë“±ë¡ë˜ì§€ ì•ŠìŒ

**í•´ê²°**:
- `app/models/__init__.py`ì— DailyRanking import ì¶”ê°€
- `app/crud/__init__.py`ì— daily_ranking import ì¶”ê°€
- `app/utils/__init__.py` ìƒì„±

### ë¬¸ì œ 2: ëª…ë ¹ì–´ ì‹¤í–‰ ì§€ì—°
**ì›ì¸**: Docker ëª…ë ¹ì–´ ì‘ë‹µ ì§€ì—°/ì·¨ì†Œ

**ìƒíƒœ**: ì¬ì‹œë„ ì¤‘

---

## ğŸ“‹ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì˜ì—…ì¼ 15:30 ì´ì „ (í˜„ì¬ ì‹œê° ê¸°ì¤€)
1. API í˜¸ì¶œ â†’ KIS API ì¡°íšŒ
2. DB ì €ì¥ ì•ˆ í•¨
3. ìºì‹œ ì €ì¥ (10ì´ˆ)
4. í…Œë§ˆë³„ ë¶„ë¥˜í•˜ì—¬ ì‘ë‹µ

### ì˜ì—…ì¼ 15:30 ì´í›„
1. API í˜¸ì¶œ â†’ KIS API ì¡°íšŒ
2. DBì— ë‹¹ì¼ ë°ì´í„° ì €ì¥
3. ìºì‹œ ì €ì¥ (10ì´ˆ)
4. í…Œë§ˆë³„ ë¶„ë¥˜í•˜ì—¬ ì‘ë‹µ

### íœ´ì¼ (í† , ì¼)
1. API í˜¸ì¶œ â†’ ë§ˆì§€ë§‰ ì˜ì—…ì¼ ê³„ì‚°
2. DBì—ì„œ í•´ë‹¹ ë‚ ì§œ ë°ì´í„° ì¡°íšŒ
3. ìºì‹œ ì €ì¥ (10ì´ˆ)
4. í…Œë§ˆë³„ ë¶„ë¥˜í•˜ì—¬ ì‘ë‹µ

---

## ğŸ“Š ë°ì´í„° íë¦„

```
ì˜ì—…ì¼ 15:30 ì´ì „:
KIS API (100ê°œ) â†’ ìºì‹œ(10ì´ˆ) â†’ í…Œë§ˆ ë¶„ë¥˜ â†’ ì‘ë‹µ

ì˜ì—…ì¼ 15:30 ì´í›„:
KIS API (100ê°œ) â†’ DB ì €ì¥ â†’ ìºì‹œ(10ì´ˆ) â†’ í…Œë§ˆ ë¶„ë¥˜ â†’ ì‘ë‹µ

íœ´ì¼:
ë§ˆì§€ë§‰ ì˜ì—…ì¼ ê³„ì‚° â†’ DB ì¡°íšŒ â†’ ìºì‹œ(10ì´ˆ) â†’ í…Œë§ˆ ë¶„ë¥˜ â†’ ì‘ë‹µ
```

---

## ğŸ“ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡

### ì‹ ê·œ íŒŒì¼ (3ê°œ)
1. `app/models/daily_ranking.py` - DB ëª¨ë¸
2. `app/utils/business_day.py` - ì˜ì—…ì¼ íŒë‹¨
3. `app/crud/daily_ranking.py` - CRUD í•¨ìˆ˜

### ìˆ˜ì • íŒŒì¼ (6ê°œ)
1. `app/models/__init__.py` - DailyRanking import
2. `app/crud/__init__.py` - daily_ranking import
3. `app/utils/__init__.py` - ì‹ ê·œ ìƒì„±
4. `app/api/v1/rankings.py` - ì˜ì—…ì¼/íœ´ì¼ ë¡œì§
5. `requirements.txt` - pytz ì¶”ê°€
6. (ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„± ì˜ˆì •)

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

1. âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ì™„ë£Œ í™•ì¸
2. â³ Backend ì¬ì‹œì‘ í™•ì¸
3. â³ API í…ŒìŠ¤íŠ¸
   - ì˜ì—…ì¼ ë¡œì§ í…ŒìŠ¤íŠ¸
   - íœ´ì¼ ë¡œì§ í…ŒìŠ¤íŠ¸
   - DB ì €ì¥ í™•ì¸
4. â³ Frontend í™”ë©´ í™•ì¸

---

## ğŸ’¡ ê°œì„  ê°€ëŠ¥ ì‚¬í•­

### í–¥í›„ í™•ì¥
- [ ] í•œêµ­ ê³µíœ´ì¼ ë°ì´í„° ì¶”ê°€ (í•œêµ­ê±°ë˜ì†Œ API)
- [ ] ì¥ ì‹œì‘ ì‹œê°„(09:00) ì²´í¬
- [ ] DB ë°ì´í„° ë³´ê´€ ê¸°ê°„ ì„¤ì • (ì˜ˆ: 30ì¼)
- [ ] Background Jobìœ¼ë¡œ 15:30 ìë™ ì €ì¥

### ì„±ëŠ¥ ìµœì í™”
- [ ] Bulk Insert ì‚¬ìš©
- [ ] ì¸ë±ìŠ¤ ìµœì í™”
- [ ] ìºì‹œ ì „ëµ ì¬ê²€í† 

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2026-02-08 00:40  
**ì‘ì—…ì**: AI Assistant (Antigravity)  
**ìƒíƒœ**: ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ì¤‘
